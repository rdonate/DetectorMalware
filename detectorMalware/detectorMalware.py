#! - * - coding UTF-8 - * -

from src.extract_features.extract_features import extract_features
from src.misc.splits import split_Source_Trainning,split_Source_Test
from src.model.create_model import create_Model
from src.model.prediction import prediction
from src.model.selection_filter import calculateDiscreeting, calculateRanking
from envparse import env
from multiprocessing import Pool
import datetime
from functools import partial
from src.mongo.database import DataBaseMongo
from src.misc.open_sources import open_sources
from pymongo import IndexModel, ASCENDING


def main():
    start=datetime.datetime.now().time().strftime('%j %H:%M:%S')
    print(start)
    ip_Server_Mongo = env.str('IP_SERVER_MONGO', default='172.16.0.2')
    db_Name = env.str('DB_NAME', default='tfg')
    order = env.int('ORDER_EXTRACT_FEUTURES_ASM', default=4)
    dir_Data_Raw=env.str('DIR_DATA_RAW', default='/data/raw')
    seed=env.int('SEED',default=1234)
    thread=env.int('THREAD',default=4)
    num_features = env.int('NUM_FEATURES', default=50)
    sample = env.bool('SAMPLE', default=False)
    perform_Method=env.str('PERFORM_METHOD', default='ALL')
    names_collections=('total', 'features', 'rankingFeatures', 'discreeting')
    prefix_collections='train'
    dir_OriginDataTrain=dir_Data_Raw+'DataBase/trainLabels.csv'
    if sample:
        from src.misc.sample import selectSample
        percentage_sample = env.float('PERCENTAGE_SAMPLE', default=5)
        dir_OriginDataTrain = selectSample(percentage_sample,seed,dir_Data_Raw)
        del percentage_sample
    del sample
    lengthDB, sources = open_sources(split_Source_Trainning, dir_OriginDataTrain)
    if perform_Method=='EXTRACT_TRAIN' or perform_Method == 'EXTRACT_ALL' or perform_Method=='ALL':
        db = DataBaseMongo(ip_Server_Mongo, db_Name)
        for colection in names_collections:
            db.selectCollection(prefix_collections+'_'+colection).drop()
        del db
        pool=Pool(thread)
        extracts_features_train = partial(extract_features, ip_Server_Mongo, db_Name, dir_Data_Raw + 'DataBase/', prefix_collections, order, names_collections)
        pool.map(extracts_features_train, sources)
        pool.close()
        pool.join()
        db = DataBaseMongo(ip_Server_Mongo, db_Name)
        collection_features = db.selectCollection(prefix_collections + '_' + names_collections[1])
        index = IndexModel([('feature', ASCENDING), ('index_file', ASCENDING)])
        collection_features.create_indexes([index])
        del extracts_features_train, db,collection_features,index, pool
    if perform_Method == 'DISCRETE' or perform_Method == 'ALL':
        calculateDiscreeting(prefix_collections, ip_Server_Mongo, db_Name, names_collections, lengthDB)
    if perform_Method == 'SELECT' or perform_Method == 'ALL':
        calculateRanking(prefix_collections, ip_Server_Mongo, db_Name, names_collections, num_features, lengthDB)
    if perform_Method == 'MODEL' or perform_Method == 'MODEL_PREDICT' or perform_Method == 'ALL':
        model = create_Model(prefix_collections, ip_Server_Mongo, db_Name,names_collections, lengthDB, num_features, seed)
    dir_OriginDataTest = dir_Data_Raw+'DataBase/sampleSubmission.csv'
    prefix_collections = 'test'
    lengthDB, sources = open_sources(split_Source_Test, dir_OriginDataTest)
    if perform_Method == 'EXTRACT_TEST' or perform_Method == 'EXTRACT_ALL' or perform_Method == 'ALL':
        db = DataBaseMongo(ip_Server_Mongo, db_Name)
        for colection in names_collections:
            db.selectCollection(prefix_collections + '_' + colection).drop()
        del db
        pool = Pool(thread)
        extracts_features_test = partial(extract_features, ip_Server_Mongo, db_Name, dir_Data_Raw + 'DataBase/', prefix_collections, order, names_collections)
        pool.map(extracts_features_test, sources)
        pool.close()
        pool.join()
        db = DataBaseMongo(ip_Server_Mongo, db_Name)
        collection_features = db.selectCollection(prefix_collections + '_' + names_collections[1])
        index = IndexModel([('feature', ASCENDING), ('index_file', ASCENDING)])
        collection_features.create_indexes([index])
        del extracts_features_test, db, collection_features, index
    if perform_Method == 'PREDICT' or perform_Method == 'MODEL_PREDICT' or perform_Method == 'ALL':
        prediction(model,ip_Server_Mongo, db_Name, prefix_collections, names_collections, num_features, lengthDB, dir_OriginDataTest)
    finish=datetime.datetime.now().time().strftime('%j %H:%M:%S')
    print(finish)
    print(datetime.datetime.strptime(finish,'%j %H:%M:%S') - datetime.datetime.strptime(start,'%j %H:%M:%S'))

if __name__ == '__main__':
    main()
