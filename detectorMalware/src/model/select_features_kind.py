#! - * - coding UTF-8 - * -

from src.mongo.database import DataBaseMongo
import numpy as np

def select_features(ip_Server_Mongo, db_Name, prefix_collections, names_collections, num_features, lenghtDB):
    db = DataBaseMongo(ip_Server_Mongo,db_Name)
    features=np.zeros((lenghtDB, num_features))
    labels=np.zeros(lenghtDB)
    include_labels = False
    collection = db.selectCollection(prefix_collections + '_' + names_collections[2])
    sources = collection.aggregate([{'$lookup':{'from':prefix_collections+'_'+names_collections[1],
                                                'localField':'feature',
                                                'foreignField':'feature',
                                                'as':'fromFeatures'}}]
                                   ,allowDiskUse=True)
    for source in sources:
        for value in source['fromFeatures']:
            features[value['index_file'],source['position']]=value['n_count']
            if 'label' in value:
                labels[value['index_file']]=value['label']
                include_labels=True
    index_labels_zero = np.reshape(np.argwhere(labels == 0), len(np.argwhere(labels == 0)))
    for index_label in index_labels_zero:
        labels[index_label]=db.selectCollection(prefix_collections + '_' + names_collections[0]).find_one({'_id':int(index_label)})['label']
    if (not include_labels):
        return features
    return features, labels