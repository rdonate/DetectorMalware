#! - * - coding UTF-8 - * -
import re
import zipfile
from ..misc.string import arrayToString

def partition_bytes(line):
    if re.match(r'((([0-9A-F]{2})|\?\?) )*((([0-9A-F]{2})|\?\?) ) ', line):
        line= line.split('  ', maxsplit=1)
        line[0] = re.sub(r'^ +', '', line[0])
        line[0] = re.sub(r' +$', '', line[0])
        line[1] = re.sub(r'^ +', '', line[1])
        line[1] = re.sub(r' +$', '', line[1])
    elif re.match(r'((([0-9A-F]{2})|\?\?) )*((([0-9A-F]{2})|\?\?)\+)', line):
        line = re.split('\+', line, maxsplit=1)
        line[0] = line[0] + '+'
    elif re.match(r'^\s*(([0-9A-F]{2}|\?\?) )*([0-9A-F]{2}|\?\?)\+?\s*$', line):
        line = re.sub(r'^ +', '', line)
        line = re.sub(r' +$', '', line)
        line = [line]
    elif ' ' in line:
        flag=True
        index=0
        line = re.sub(r'^ +', '', line)
        line = re.sub(r' +$', '', line)
        auxline=re.split(r' +',line)
        while flag and index < len(auxline):
            if re.match(r'^(([0-9A-F]{2})|\?\?)\+?$',auxline[index]):
                index+=1
            else:
                flag = False
        line = [ arrayToString(auxline[:index]) , arrayToString(auxline[index:]) ]
        del auxline
    else:
        line = ['', line]
    return line

def extract_Features_Asm(file, db, dir_Data_Raw, source):
    collection_asm = db.selectCollection(file+'_'+'asm')
    collection_section = db.selectCollection(file+'_'+'section')
    collection_total = db.selectCollection(file+'_'+'total')
    with zipfile.ZipFile(dir_Data_Raw+file+'.zip','r') as input_file:
        text=input_file.read(source[0]+'.asm').decode(encoding='iso8859')
    lines = re.findall('.*$',text,re.MULTILINE)
    instructions = {}
    sections = {}
    for line in lines:
        if not line == '':
            line_raw = re.sub(r'\r', '', line)
            line_raw = re.split(r';', line_raw, 1)[0]
            line_raw = re.sub(r'^ ', '', line_raw)
            line_raw = re.sub(r'\t', ' ', line_raw)
            line_raw = re.split(r':', line_raw, maxsplit=1)
            section = line_raw.pop(0).lower()
            if len(line_raw) == 1:
                line_raw = line_raw[0]
            else:
                line_raw = ''
            line_raw = re.split(r' ', line_raw, maxsplit=1)
            if len(line_raw) >0:
                dir = line_raw.pop(0)
            else:
                dir = ''
            if len(line_raw) == 1:
                line_raw = line_raw[0]
            else:
                line_raw = ''
            if not section in sections:
                sections[section] = set()
            sections[section].add(dir)
            del section
            if not re.match(r'^ *$', line_raw):
                line_raw = partition_bytes(line_raw)
                bytes = re.split(r' ', line_raw[0])
                line_raw.pop(0)
                if len(line_raw) == 1:
                    line_raw = line_raw[0]
                else:
                    line_raw = ' '
                line_raw = re.split(r'\s+', line_raw, maxsplit=1)
                instruction = line_raw.pop(0)
                if len(line_raw) == 1:
                    line_raw = line_raw[0]
                else:
                    line_raw = ''
                if '_' in instruction and not re.match(r'((^_)|(^\?+_))', instruction):
                    aux_instruction = re.split(r'_', instruction)
                    instruction = aux_instruction.pop(0)
                    line_raw =  arrayToString(aux_instruction)+ ' ' + line_raw
                    del aux_instruction
                instruction = re.sub(r'_+','',instruction)
                instruction = re.sub(r'^\?+_?','',instruction)
                instruction = re.sub(r'(\s*:\s*|\s+=\s+|\s*,\s*)$','', instruction)
                if ' ' in line_raw and not re.match(r'^ *$', line_raw):
                    line_raw = re.sub(r'^ +', '', line_raw)
                    line_raw = re.sub(r' +$', '', line_raw)
                    args = re.split(r' +', line_raw)
                else:
                    args = []
                    args.append(line_raw)
            else:
                bytes = []
                instruction = ''
                args = []
            if instruction in instructions:
                instructions[instruction] += 1
            else:
                instructions[instruction] = 1
    del line, line_raw, instruction
    total_instructions = 0
    for instruction in instructions.keys():
        total_instructions+=instructions[instruction]
        data_instruction = {'file': source[0], 'instruction': instruction, 'count': instructions[instruction]}
        if len(source)==2:
            data_instruction['class']= source[1]
        collection_asm.insert(data_instruction)
    total_sections = 0
    for section in sections.keys():
        total_sections+=len(sections[section])
        data_section = {'file': source[0], 'section': section, 'count': len(sections[section])}
        if len(source)==2:
            data_section['class']= source[1]
        collection_section.insert(data_section)
    data_total = collection_total.update_one_insert_features({'_id':source[0]},{'instrutions':total_instructions,'sections':total_sections})
    input_file.close()
    del collection_total, collection_section, collection_asm, text, lines, instructions, sections, total_sections, total_instructions, data_total,  args, bytes, dir

