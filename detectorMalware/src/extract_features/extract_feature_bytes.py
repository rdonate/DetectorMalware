#! - * - coding UTF-8 - * -
import zipfile
from ..mongo.database import DataBaseMongo

def extract_Feature_Byte(prefix_collections, ip_Server_Mongo, db_Name, dir_Data_Raw, source, order, names_collections):
    db = DataBaseMongo(ip_Server_Mongo, db_Name)
    collection_bytes = db.selectCollection(prefix_collections + '_' + names_collections[1])
    collection_total = db.selectCollection(prefix_collections + '_' + names_collections[0])
    with zipfile.ZipFile(dir_Data_Raw + prefix_collections + '.zip', 'r') as input_file:
        text=input_file.read(source[1]+'.bytes').decode()
    lines=text.split('\r\n')
    all_elems_codes=[]
    ngrams={}
    for line in lines:
        elems=line.split(' ')
        all_elems_codes.extend(elems[1:])
    for a in range(len(all_elems_codes)-order+1):
        ngram=all_elems_codes[a]
        for x in range(a+1, a + order):
            ngram += " " + all_elems_codes[x]
        ngrams[ngram] = ngrams.get(ngram, 0) +1
    del ngram, all_elems_codes, line
    total_ngrams=0
    for ngram in ngrams.keys():
        if not ngram == '':
            total_ngrams+=ngrams[ngram]
    for ngram in ngrams.keys():
        if not ngram == '':
            data = {'index_file':source[0], 'name_file': source[1], 'feature': 'b_'+ngram.lower(), 'count': ngrams[ngram], 'n_count': ngrams[ngram]/total_ngrams,'kind':'bytes'}
            if len(source)==3:
                data['label']= source[2]
            collection_bytes.insert(data)
    data = collection_total.update_one({'_id':source[0]}, {'$set':{'ngrams':total_ngrams}})
    input_file.close()
    del db, ngrams, collection_bytes, collection_total, data, total_ngrams, lines,text
