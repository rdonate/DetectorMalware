from src.mongo.database import DataBaseMongo
from src.extract_features.extract_features import extract_features as feautures
from envparse import env
import re
from multiprocessing import Pool
import datetime
from functools import partial



def split_Source_Trainning(source):
    source=re.sub('"','',source)
    source=source.split(",")
    if len(source)>1 and not source[1]=='Class':
        source[1]=int(source[1])
    return tuple(source)

def split_Source_Test(source):
    source=re.sub('"','',source)
    source=source.split(",")
    return tuple(source[:1])


def extracts_features(dir_Data_Raw, ip_Server_Mongo, db_Name, order, file, source):
    db = DataBaseMongo(ip_Server_Mongo, db_Name)
    feautures(dir_Data_Raw + 'DataBase/', file, db, order, source)
    del db


def main():
    start=datetime.datetime.now().time().strftime('%H:%M:%S')
    print(start)
    ip_Server_Mongo = env.str('IP_SERVER_MONGO', default='172.16.0.2')
    db_Name = env.str('DB_NAME', default='tfg')
    order = env.int('ORDER_EXTRACT_FEUTURES_ASM', default=4)
    dir_Data_Raw=env.str('DIR_DATA_RAW', default='/data/raw')
    seed=env.int('SEED',default=1234)
    thread=env.int('THREAD',default=4)
    sample = env.bool('SAMPLE', default=False)
    perform_Method=env.str('PERFORM_METHOD', default='ALL')
    if perform_Method=='TRAIN' or perform_Method=='ALL':
        with open(dir_Data_Raw+'DataBase/trainLabels.csv','r') as file:
            text = file.read()
        sources = map(split_Source_Trainning, text.split('\n')[1:-1])
        if sample:
            from src.misc.sample import selectSample
            percentage_sample = env.float('PERCENTAGE_SAMPLE', default=5)
            sources = selectSample(percentage_sample,seed,sources)
            del percentage_sample
        del sample
        # for source in sources:
        #     extracts_features_train(source)
        pool=Pool(thread)
        extracts_features_train = partial(extracts_features, dir_Data_Raw, ip_Server_Mongo, db_Name, order, 'train')
        pool.map(extracts_features_train, sources)
        del extracts_features_train
    if perform_Method == 'MODEL' or perform_Method == 'MODEL_PREDICT' or perform_Method == 'ALL':
        pass
    if perform_Method == 'PREDICT' or perform_Method == 'MODEL_PREDICT' or perform_Method == 'ALL':
        with open(dir_Data_Raw+'DataBase/sampleSubmission.csv','r') as file:
            text = file.read()
        sources = map(split_Source_Test, text.split('\n')[1:-1])
        pool = Pool(thread)
        extracts_features_test = partial(extracts_features, dir_Data_Raw, ip_Server_Mongo, db_Name, order, 'test')
        pool.map(extracts_features_test, sources)
    finish=datetime.datetime.now().time().strftime('%H:%M:%S')
    print(finish)
    print(datetime.datetime.strptime(finish,'%H:%M:%S') - datetime.datetime.strptime(start,'%H:%M:%S'))

if __name__ == '__main__':
    main()
