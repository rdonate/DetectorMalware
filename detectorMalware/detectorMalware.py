from src.mongo.database import DataBaseMongo
from src.extract_features.extract_features import extract_features as feautures
from envparse import env
import re
from multiprocessing import Pool
from time import time



def split_Source(source):
    source=re.sub('"','',source)
    source=source.split(",")
    if len(source)>1 and not source[1]=='Class':
        source[1]=int(source[1])
    return tuple(source)


def extracts_features(source):
    ip_Server_Mongo = env.str('IP_SERVER_MONGO', default='172.16.0.2')
    db_Name = env.str('DB_NAME', default='tfg')
    # db = DataBaseMongo(ip_Server_Mongo, db_Name)
    # del ip_Server_Mongo, db_Name
    order = env.int('ORDER_EXTRACT_FEUTURES_ASM', default=4)
    dir_Data_Raw = env.str('DIR_DATA_RAW', default='/data/raw')
    feautures(dir_Data_Raw + "DataBase/train/",ip_Server_Mongo, db_Name, order,source)
    #del db
    del order,dir_Data_Raw

def main():
    seed=env.int('SEED',default=1234)
    thread=env.int('THREAD',default=4)
    sample = env.bool('SAMPLE', default=False)
    dir_Data_Raw=env.str('DIR_DATA_RAW',default='/data/raw')
    with open(dir_Data_Raw+'DataBase/trainLabels.csv','r') as file:
        text = file.read()

    sources = map(split_Source, text.split('\n')[1:-1])
    if sample:
        from src.misc.sample import selectSample
        percentage_sample = env.float('PERCENTAGE_SAMPLE', default=5)
        sources = selectSample(percentage_sample,seed,sources)
        del percentage_sample
    del sample
    ip_Server_Mongo = env.str('IP_SERVER_MONGO', default='172.16.0.2')
    db_Name = env.str('DB_NAME', default='tfg')
    db = DataBaseMongo(ip_Server_Mongo, db_Name)
    order = env.int('ORDER_EXTRACT_FEUTURES_ASM', default=4)
    dir_Data_Raw = env.str('DIR_DATA_RAW', default='/data/raw')
    start=time()
    print(start)
    pool=Pool(thread)
    pool.map(extracts_features, sources)
    finish=time()
    print(finish)
    print(finish-start)
    del ip_Server_Mongo, db_Name
    # del order, extract_Features
    del db
    del order, dir_Data_Raw
    # del db

if __name__ == '__main__':

    main()
