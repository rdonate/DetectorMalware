from src.mongo.database import DataBaseMongo
from src.extract_features.extract_features import extract_features as feautures
from envparse import env
import re
from multiprocessing import Pool
import datetime
import time



def split_Source(source):
    source=re.sub('"','',source)
    source=source.split(",")
    if len(source)>1 and not source[1]=='Class':
        source[1]=int(source[1])
    return tuple(source)


def extracts_features(source,file):
    db = DataBaseMongo(ip_Server_Mongo, db_Name)
    feautures(dir_Data_Raw + 'DataBase/'+file,db, order, source)
    del db

def extracts_features_train(source):
    extracts_features(source,'train.zip')


def main():
    global ip_Server_Mongo
    global db_Name
    global order
    global dir_Data_Raw
    global seed
    ip_Server_Mongo = env.str('IP_SERVER_MONGO', default='172.16.0.2')
    db_Name = env.str('DB_NAME', default='tfg')
    order = env.int('ORDER_EXTRACT_FEUTURES_ASM', default=4)
    dir_Data_Raw=env.str('DIR_DATA_RAW', default='/data/raw')
    seed=env.int('SEED',default=1234)
    thread=env.int('THREAD',default=4)
    sample = env.bool('SAMPLE', default=False)
    with open(dir_Data_Raw+'DataBase/trainLabels.csv','r') as file:
        text = file.read()
    sources = map(split_Source, text.split('\n')[1:-1])
    if sample:
        from src.misc.sample import selectSample
        percentage_sample = env.float('PERCENTAGE_SAMPLE', default=5)
        sources = selectSample(percentage_sample,seed,sources)
        del percentage_sample
    del sample
    # db = DataBaseMongo(ip_Server_Mongo, db_Name)
    # for source in sources:
    #     extracts_features_train(source)
    start=datetime.datetime.now().time().strftime('%H:%M:%S')
    print(start)
    pool=Pool(thread)
    pool.map(extracts_features_train, sources)
    finish=datetime.datetime.now().time().strftime('%H:%M:%S')
    print(finish)
    print(datetime.datetime.strptime(finish,'%H:%M:%S') - datetime.datetime.strptime(start,'%H:%M:%S'))
    # del db

if __name__ == '__main__':
    main()
