#! - * - coding UTF-8 - * -
import re
import zipfile
import sys
def extract_Features_Asm(db, dir_Data_Raw, source):
    collection_asm = db.selectCollection('asm')
    collection_section = db.selectCollection('section')
    collection_total = db.selectCollection('total')
    with zipfile.ZipFile(dir_Data_Raw,'r') as input_file:
    #with open(dir_Data_Raw + source[0] + ".asm", 'r', encoding='iso8859') as input_file:
        text=input_file.read(source[0]+'.asm').decode(encoding='iso8859')
    lines = text.split('\n')
    instructions = {}
    sections = {}
    for line in lines:
        if not line == '':
            line_raw = re.split(r';', line, 1)[0]
            line_raw = re.sub(r'\r', '', line_raw)
            line_raw = re.sub(r'^ ', '', line_raw)
            line_raw = re.sub(r'\t', ' ', line_raw)
            line_raw = re.split(r':| ', line_raw, maxsplit=2)
            section = line_raw.pop(0)
            if len(line_raw) > 0:
                dir = line_raw.pop(0)
            else:
                dir = ''
            if not section in sections:
                sections[section] = set()
            sections[section].add(dir)
            del section
            if len(line_raw) == 1:
                line_raw = line_raw[0]
            else:
                line_raw = ''
            if not re.match(r'^ *$', line_raw):
                if '  ' in line_raw:
                    line_raw = line_raw.split('  ', maxsplit=1)
                    line_raw[0] = re.sub(r'^ +', '', line_raw[0])
                    line_raw[0] = re.sub(r' +$', '', line_raw[0])
                    line_raw[1] = re.sub(r'^ +', '', line_raw[1])
                    line_raw[1] = re.sub(r' +$', '', line_raw[1])
                else:
                    if '+' in line_raw:
                        line_raw = re.split('\+', line_raw, maxsplit=1)
                        line_raw[0] = line_raw[0] + '+'
                    elif 'a' in line_raw:
                        line_raw = re.split(r'a', line_raw, maxsplit=1)
                        line_raw[1] = 'a' + line_raw[1]
                    elif 'o' in line_raw:
                        line_raw = re.split(r'o', line_raw, maxsplit=1)
                        line_raw[1] = 'o' + line_raw[1]
                    elif '_' in line_raw:
                        line_raw = re.split('_', line_raw, maxsplit=1)
                        line_raw[1] = '_' + line_raw[1]
                    elif '?' in line_raw:
                        line_raw = re.split('\?', line_raw, maxsplit=1)
                        line_raw[1] = '?' + line_raw[1]
                    elif re.match(r'^([0-9A-F\?]{2}\+? ?)*$', line_raw):
                        line_raw = [line_raw]
                    else:
                        print(source[0])
                        print('Revisar bytes ' + str(line_raw) + ' en linea ' + line + ' en fichero ' + source[0])
                        sys.exist(5)
                bytes = re.split(r' ', line_raw[0])
                line_raw.pop(0)
                if len(line_raw) == 1:
                    line_raw = line_raw[0]
                else:
                    line_raw = ' '
                line_raw = re.split(r'\s+', line_raw, maxsplit=1)
                instruction = line_raw.pop(0)
                if len(line_raw) == 1:
                    line_raw = line_raw[0]
                else:
                    line_raw = ''
                if '_' in instruction and not re.match(r'^_', instruction):
                    aux_instruction = re.split(r'_', instruction)
                    instruction = aux_instruction.pop(0)
                    aux_args = ''
                    for aux_arg in aux_instruction:
                        aux_args = aux_args + aux_arg + ' '
                    line_raw = aux_args + line_raw
                    del aux_instruction, aux_args, aux_arg
                if ' ' in line_raw and not re.match(r'^ *$', line_raw):
                    line_raw = re.sub(r'^ +', '', line_raw)
                    line_raw = re.sub(r' +$', '', line_raw)
                    args = re.split(r' +', line_raw)
                else:
                    args = []
                    args.append(line_raw)
            else:
                bytes = []
                instruction = ''
                args = []
            if instruction in instructions:
                instructions[instruction] += 1
            else:
                instructions[instruction] = 1
    del line, line_raw, instruction
    total_instructions = 0
    for instruction in instructions.keys():
        total_instructions+=instructions[instruction]
        data_instruction = {'file': source[0], 'instruction': instruction, 'count': instructions[instruction]}
        if len(source)==2:
            data_instruction['class']= source[1]
        collection_asm.insert(data_instruction)
    total_sections = 0
    for section in sections.keys():
        total_sections+=len(sections[section])
        data_section = {'file': source[0], 'section': section, 'count': len(sections[section])}
        if len(source)==2:
            data_section['class']= source[1]
        collection_section.insert(data_section)
    data_total = collection_total.find_one({'_id':source[0]})
    data_total['instructions'] = total_instructions
    data_total['sections'] = total_sections
    collection_total.save(data_total)
    input_file.close()
    del collection_total, collection_section, collection_asm, text, lines, instructions, sections, total_sections, total_instructions, data_total, data_instruction, data_section, args, bytes, dir