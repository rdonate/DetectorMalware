#! - * - coding UTF-8 - * -
import re
import zipfile
def extract_Features_Asm(db, dir_Data_Raw, source):
    collection_asm = db.selectCollection('asm')
    collection_section = db.selectCollection('section')
    with zipfile.ZipFile(dir_Data_Raw,'r') as input_file:
    #with open(dir_Data_Raw + source[0] + ".asm", 'r', encoding='iso8859') as input_file:
        text=input_file.read(source[0]+'.asm').decode(encoding='iso8859')
    lines=text.split('\n')
    instructions={}
    sections={}
    for line in lines:
        if not line=='':
            d = []
            args = []
            a = re.split(r';',line,1)[0]
            a = re.sub(r'\t',' ',a)
            a = re.split(r':|\s',a,maxsplit=2)
            section=a.pop(0)
            dir=a.pop(0)
            if len(a)==1 and not re.match(r'^\s+$',a[0]):
                d = re.split(r'( {2})+',a[-1],maxsplit=1)
                if '  ' in d:
                    d.remove('  ')
                if len(d)>=2:
                    args = re.split(r'\s+',d[-1])
            if len(args)>0 and args[0]=='' and isinstance(args, list):
                args.pop(0)
            if len(d)>=1 and isinstance(d,list):
                if not d[0]=='':
                    bytes=d[0].split(" ")
                else:
                    bytes=[]
            else:
                bytes=d
            if len(args)>0:
                instruction=args.pop(0)
                if len(args)>0:
                    if '' in args:
                        args.remove('')
                else:
                    args=[]
            else:
                instruction=''
                args=[]
            if instruction in instructions:
                instructions[instruction] += 1
            else:
                instructions[instruction] = 1
            if section in sections:
                sections[section] += 1
            else:
                sections[section] = 1
    del instruction
    for instruction in instructions.keys():
        data = {'file': source[0], 'class': source[1], 'instruction': instruction, 'count': instructions[instruction]}
        collection_asm.insert(data)
    del data,section, instructions,collection_asm
    for section in sections.keys():
        data = {'file': source[0], 'class': source[1], 'section': section, 'count': sections[section]}
        collection_section.insert(data)
    del section,sections,data,collection_section
