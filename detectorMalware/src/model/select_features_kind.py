import numpy as np
from src.misc.open_sources import open_sources

def select_features(ip_Server_Mongo, db_Name, prefix_collections, names_collections, list_features, lenghtDB, dir_SourceData, split_Source):
    from ..mongo.database import DataBaseMongo
    db = DataBaseMongo(ip_Server_Mongo,db_Name)
    features=np.zeros(lenghtDB)
    collection = db.selectCollection(prefix_collections + '_' + names_collections[2])
    sources=open_sources(split_Source,dir_SourceData)
    for source in sources:
        len_source=len(source)
        assert len_source==2 or len_source==3 , "Review source in Select Features Labels"
        data = np.zeros(len(list_features) + len_source-2)
        if len_source==3:
            data[-1]=source[1]
        del len_source
        for index,feature in enumerate(list_features):
            source_data = collection.find_one({'index_file':source[0], 'feature':feature})
            if source_data!=None:
                data[index]=source_data['n_count']
            else:
                data[index]=0
        print(data)
        features = np.append(features,data)
    assert len(features)%len(data)==0, "Review len of Data on Select Features Kind"
    features=np.reshape(features,(lenghtDB,len(data)))
    return features

def split_features_and_labels(features):
    labels=features[:,-1]
    aux_features=features[:,:-1]
    return aux_features, labels

def features_and_labels_one_feature(prefix_collections, ip_Server_Mongo, name_collection, db_Name, length, feature):
    from ..mongo.database import DataBaseMongo
    db = DataBaseMongo(ip_Server_Mongo, db_Name)

    collection_features = db.selectCollection(prefix_collections + '_' + name_collection)
    query = collection_features.aggregate([{'$match': {'feature': feature}},
                                           {'$group': {'_id': '$feature',
                                                       'data': {'$addToSet': {'index': '$index_file',
                                                                              'count': '$n_count',
                                                                              'label': '$label'}}}}],
                                          allowDiskUse=True)
    data = np.zeros((length, 2))
    try:
        element = query.next()
        for value in element['data']:
            data[value['index'], 0] = value['count']
            data[value['index'], 1] = value['label']
    except Exception as e:
        pass
    del db, collection_features, query
    return split_features_and_labels(data)